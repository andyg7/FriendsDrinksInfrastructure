language: generic
os: linux
arch:
  - amd64
branches:
  - main
env:
  global:
  - AWS_DEFAULT_REGION=us-east-1

jobs:
  include:
    - stage: Deploy CloudFormation role
      env:
        - secure: "NTDkW1owt0tIXbd2BoLjcUHunQYlsD+NMW3zVASAw40KI2EavoI4ZhGg9UOe+0Aym/LaWMA7E0HNfMBNiLHochBEoxcL8rWRvCLeS1O0nNuTSx/wG/2L5AMoTkZhQ3ibfovJAN/mgkrtRk8hC/xHi5H/GxZzwEQlCT7vK2MH/xNJfStwLvcHnyYZlPcAML9b1xogETsoJyPPc9Sw1nVnJrUuT1plk3Jw/CTTYyD4JFt6tuNXBrkKpI4viAO7Kf2rdD6JQAUKw4IgRDzcoLQFIF0SSn3xQ/PQZrHF/u0e3gU+FBK/7L9vEa0IukopLJvqng12JGZtmUos1OUuKXnRcEyllshWmYz3SPPfXcV17HW741R8EMdaJ9l8ld+kWvvNArC9WGg054gTAkxf1Qz+P+9IKCE/fAjhz7AZa408dkmmnfQwr71WmmAaKHslWqru5AUOfcPa3tt+uQc7Jqn3A44m1AKvqs3yEkcGmfYy25gtKGnridCJ9sfF84sw7c4me8Nxbx+IUUtA+93txJZhWfLuxHt2Q0VUAW6T0q1MXPcaMefvz9TtmuPk5sT63brXAUlOiggjlUxyGMZtAOqAhfZYvXd713MKjkRK4iqz1Y+gMeJNN3p/TKLUwWyh/mfZVZz0yLoFOXB5aCpBM+x4+qvVKjQIGlfJHVj6mtkJoJc="
        - secure: "IYw7MGxZ06gDDxzk+LeVPUWms2XFEttQf67Wbph7VtmGJWMUzmTZxOyfncrUA1W6fJHAD1DTj4UQkSjcwGeVASCXCpGF4WaElozXS+dW1JcKpMVvDfasDiwoK+MCsPbqF0HuHhbhWqyS3/v+Pst/Qi9xOIgAcDRe6NWv8FYOEuqfvPcszWD43U2f9b7yCruUcz2DOG460u7t/PQd81jtHNeC3c/+UsPtZ1wDwS1zGJCTs2PJ3oYGH1b3lGqHoEojTIqJMLqgfCs5wv1LfAFop+zMfDwWx01bRRcF2lSopHBFkx/eart93GIeIG7ZvDAuglc7dfGoGiF7vHoabfZsVBvjCdTdNZljABUSHvAKZUvbcaTkQUJe2nI+gpXjFyCU2NafdmJWVbjGDVL9kQmr6XOexEPtGyI740MDPHiwsicKNg3zDAZb0xA3hCnL82wJiCvRWxGQHpUF3FLFJ6GwcJPAkLrwt+KWfMrVeUow2Lgi21WDmv8suNiNHZ9S7IdbMzgFa7k4+Fok4G5tM6Pfcuf9eBIDwO3DLmXTn7rPBEMtJk77SvJRhlV9WgLiU7NSgalUhu4TM5pF73kiTpUyEYb2wmIlejiP9Jwqe2guSRNEvfpq+01Xxhtxaot50RQ82v27cMKLmt03p2MwCQyryHJskl+LO6d0+3PpRbibOac="
      install:
        - curl "https://awscli.amazonaws.com/awscli-exe-linux-x86_64.zip" -o "awscliv2.zip"
        - unzip awscliv2.zip
        - sudo ./aws/install
        - aws --version
      script:
        - cat cloudformation/kubernetes_cluster_admin_role.yml
        - aws cloudformation validate-template --template-body file://cloudformation/kubernetes_cluster_admin_role.yml
        - aws cloudformation deploy --template-file cloudformation/kubernetes_cluster_admin_role.yml --stack-name KubernetesClusterAdminRole --capabilities CAPABILITY_IAM
        - aws cloudformation list-exports | jq -r '.Exports[] | select(.Name=="KubernetesClusterAdminRole-RoleArn") | .Value' > rolearn
      workspaces:
        create:
          name: ws1
          paths:
            - rolearn
    - stage: Deploy Kubernetes VPC infrastructure
      workspaces:
        use: ws1
      env:
        - secure: "PXOnvZ3NPuRk61/5DKxxjAfmodq9BnRhBoYxlTspHmWolQvXdPlewwi5xORxJhU8OncmDAvd/jPQlVp59NYHENIQCKTCxO5e+05B9TKG5r2mHyW8DzHFmlD2rgfe4ijSrFvE2gszcrc+JuG/DLqo4x5ct57bm4MXSYS75JwIaKfk/HpCKYRdt82jpJXdfvYPxRkqRYIyZSkhmYJt6irT14Gva1FledO/LztRg8BZkqqthfNI1RWsYDOf9NODXZt3lFyerk/sjKURG8cRNiz3hAWjOPIjSZS1Pf7SLM1NOxH33t3E0bMdG66t/D2zJKenUcDpfMCyUMUGVEI9e43SrNDC0JVJS4bLFpV1Okgnwm1wjdWKguUUj9wBtcOljMGbfo4ynoxcy7g5tY8il7RVHbMmqE9KLiEvoU3654gU5axOvoTsfW//5MwijbeUZAb9vKAM0u+SA+wXoXB5y6zwFX5Fy6L+103hF7d+E4mXE3mRp8PLkIV9QwFalpCCykYGQMNmfjrGdNuQTtw03ut8DZ1J3wE1oxHS+OkSiJptwdjRYiKgqaU6OWT+JvgGierLlP5+O9ePtpSF3gWeRXFYLC477NEFFApEgZDwHn0l94GkD1q158hxI0OrZ93V7EqMPy1h2LTpxMZOz9O/jx2nbamJOl4oxE2ikw8IoCIotHU="
        - secure: "Pmk4NV34qHMensSMptgpDaZgcsV49oBwOgh7kR5nBUv+7yJIeGLRRL36mfS09V72/0oQsDD7I20LWarXUCHEAamIeuxzT6rzmH6RljbRTgyLu0JzacGjpeNg3Pd76Q1IEAwE09QWhQ6zEfxucZXb8K6Rsl3wPBYNTzJS9h9TQ42zwejkq080H3T4SI/VSYVyQhkX840zVBWhDS8/AKh7clTSTWX/XrhOfymbksby2P7No6y57eNuPEJ6IDXNT1DUThLlAeC/vRSvZ+pyU/0lFXy6DpgASuIL1WniSnZeSPsmgJnmmUhxgfYMZIvzLfE1ecLqvVNALu75xrapgYpM9Foa2FKrcGJ7CXBw3gDSGsDUNBGlqsyR7hliR4GmTfvb48a+lHYvQjCbLnEhF0wuMHFqX9J1D9+LVSTsLry1j51hQD/Uk0gJiaMbHAwVA8wyZzPri2dNdqS/sPkeMhPn/62G2WaGZAlv+W23iP5OuvT1KLfYxN3G5o0x9w87iKwztEj80VpFZBLYqM4x4rHwDavdFAOM4/OnT99x7L+WMMzAEBPqa6pZtCOhp/scFTStRDIBiWwiubf6KpNQ6yiwyiNpz7/XsG9DikYc3TOY25hl2JIbOCb1kmSF62a/8/s2g7nshOOmNjmu9QEdW7/ap+lnksP6u2SCdvzxPK1Sr+I="
      install:
        - curl "https://awscli.amazonaws.com/awscli-exe-linux-x86_64.zip" -o "awscliv2.zip"
        - unzip awscliv2.zip
        - sudo ./aws/install
        - aws --version
      script:
        - export AWS_ROLE_ARN=$(cat rolearn)
        - export STS_CREDENTIALS=$(aws sts assume-role --role-arn $AWS_ROLE_ARN --role-session-name VPCInfrastructureSession | jq -r '.Credentials') >/dev/null 2>&1
        - export AWS_ACCESS_KEY_ID_STS=$(echo $STS_CREDENTIALS | jq -r '.AccessKeyId') >/dev/null 2>&1
        - export AWS_SECRET_ACCESS_KEY_STS=$(echo $STS_CREDENTIALS | jq -r '.SecretAccessKey') >/dev/null 2>&1
        - export AWS_SESSION_TOKEN_STS=$(echo $STS_CREDENTIALS | jq -r '.SessionToken') >/dev/null 2>&1
        - export AWS_ACCESS_KEY_ID=$(echo $AWS_ACCESS_KEY_ID_STS) >/dev/null 2>&1
        - export AWS_SECRET_ACCESS_KEY=$(echo $AWS_SECRET_ACCESS_KEY_STS) >/dev/null 2>&1
        - export AWS_SESSION_TOKEN=$(echo $AWS_SESSION_TOKEN_STS) >/dev/null 2>&1
        - cat cloudformation/vpc.yml
        - aws cloudformation validate-template --template-body file://cloudformation/vpc.yml
        - aws cloudformation deploy --template-file cloudformation/vpc.yml --stack-name VPCInfrastructure --capabilities CAPABILITY_IAM
    - stage: Deploy Kubernetes infrastructure
      workspaces:
        use: ws1
      env:
        - secure: "PXOnvZ3NPuRk61/5DKxxjAfmodq9BnRhBoYxlTspHmWolQvXdPlewwi5xORxJhU8OncmDAvd/jPQlVp59NYHENIQCKTCxO5e+05B9TKG5r2mHyW8DzHFmlD2rgfe4ijSrFvE2gszcrc+JuG/DLqo4x5ct57bm4MXSYS75JwIaKfk/HpCKYRdt82jpJXdfvYPxRkqRYIyZSkhmYJt6irT14Gva1FledO/LztRg8BZkqqthfNI1RWsYDOf9NODXZt3lFyerk/sjKURG8cRNiz3hAWjOPIjSZS1Pf7SLM1NOxH33t3E0bMdG66t/D2zJKenUcDpfMCyUMUGVEI9e43SrNDC0JVJS4bLFpV1Okgnwm1wjdWKguUUj9wBtcOljMGbfo4ynoxcy7g5tY8il7RVHbMmqE9KLiEvoU3654gU5axOvoTsfW//5MwijbeUZAb9vKAM0u+SA+wXoXB5y6zwFX5Fy6L+103hF7d+E4mXE3mRp8PLkIV9QwFalpCCykYGQMNmfjrGdNuQTtw03ut8DZ1J3wE1oxHS+OkSiJptwdjRYiKgqaU6OWT+JvgGierLlP5+O9ePtpSF3gWeRXFYLC477NEFFApEgZDwHn0l94GkD1q158hxI0OrZ93V7EqMPy1h2LTpxMZOz9O/jx2nbamJOl4oxE2ikw8IoCIotHU="
        - secure: "Pmk4NV34qHMensSMptgpDaZgcsV49oBwOgh7kR5nBUv+7yJIeGLRRL36mfS09V72/0oQsDD7I20LWarXUCHEAamIeuxzT6rzmH6RljbRTgyLu0JzacGjpeNg3Pd76Q1IEAwE09QWhQ6zEfxucZXb8K6Rsl3wPBYNTzJS9h9TQ42zwejkq080H3T4SI/VSYVyQhkX840zVBWhDS8/AKh7clTSTWX/XrhOfymbksby2P7No6y57eNuPEJ6IDXNT1DUThLlAeC/vRSvZ+pyU/0lFXy6DpgASuIL1WniSnZeSPsmgJnmmUhxgfYMZIvzLfE1ecLqvVNALu75xrapgYpM9Foa2FKrcGJ7CXBw3gDSGsDUNBGlqsyR7hliR4GmTfvb48a+lHYvQjCbLnEhF0wuMHFqX9J1D9+LVSTsLry1j51hQD/Uk0gJiaMbHAwVA8wyZzPri2dNdqS/sPkeMhPn/62G2WaGZAlv+W23iP5OuvT1KLfYxN3G5o0x9w87iKwztEj80VpFZBLYqM4x4rHwDavdFAOM4/OnT99x7L+WMMzAEBPqa6pZtCOhp/scFTStRDIBiWwiubf6KpNQ6yiwyiNpz7/XsG9DikYc3TOY25hl2JIbOCb1kmSF62a/8/s2g7nshOOmNjmu9QEdW7/ap+lnksP6u2SCdvzxPK1Sr+I="
      install:
        - curl "https://awscli.amazonaws.com/awscli-exe-linux-x86_64.zip" -o "awscliv2.zip"
        - unzip awscliv2.zip
        - sudo ./aws/install
        - aws --version
      script:
        - export AWS_ROLE_ARN=$(cat rolearn)
        - export STS_CREDENTIALS=$(aws sts assume-role --role-arn $AWS_ROLE_ARN --role-session-name KubernetesInfrastructureSession | jq -r '.Credentials') >/dev/null 2>&1
        - export AWS_ACCESS_KEY_ID_STS=$(echo $STS_CREDENTIALS | jq -r '.AccessKeyId') >/dev/null 2>&1
        - export AWS_SECRET_ACCESS_KEY_STS=$(echo $STS_CREDENTIALS | jq -r '.SecretAccessKey') >/dev/null 2>&1
        - export AWS_SESSION_TOKEN_STS=$(echo $STS_CREDENTIALS | jq -r '.SessionToken') >/dev/null 2>&1
        - export AWS_ACCESS_KEY_ID=$(echo $AWS_ACCESS_KEY_ID_STS) >/dev/null 2>&1
        - export AWS_SECRET_ACCESS_KEY=$(echo $AWS_SECRET_ACCESS_KEY_STS) >/dev/null 2>&1
        - export AWS_SESSION_TOKEN=$(echo $AWS_SESSION_TOKEN_STS) >/dev/null 2>&1
        - cat cloudformation/kubernetes_infra.yml
        - aws cloudformation validate-template --template-body file://cloudformation/kubernetes_infra.yml
        - travis_wait 30 aws cloudformation deploy --template-file cloudformation/kubernetes_infra.yml --stack-name KubernetesInfrastructure --capabilities CAPABILITY_IAM --parameter-overrides VPCStackName=VPCInfrastructure
